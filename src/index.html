<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>äº¤è´§æé†’ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f8f9fa; padding: 20px; color: #333; }
        .editable-color, .editable-quantity, .editable-delivered { cursor: pointer; transition: all 0.2s; }
        .editable-color:hover, .editable-quantity:hover, .editable-delivered:hover { background: #e3f2fd; border-radius: 4px; transition: all 0.2s ease-in-out; }
        .inline-edit-input { border: 2px solid #007bff; border-radius: 4px; transition: border-color 0.2s ease; }
        .no-records { text-align: center; color: #6c757d; padding: 50px 20px; font-size: 16px; background: #f8f9fa; border-radius: 8px; margin-top: 15px; }
        .customer-cell { background: #e9ecef; font-weight: bold; color: #343a40; padding: 12px; border-radius: 6px; margin: 10px 0; }
        /* æ“ä½œæŒ‰é’®æ ·å¼ */
        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            transition: all 0.2s ease;
            outline: none;
            border: none;
            cursor: pointer;
        }
        
        .action-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        
        .edit-btn {
            background-color: #2196F3;
            color: white;
        }
        
        .delete-btn {
            background-color: #f44336;
            color: white;
        }
        
        .highlight-btn {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .highlight-btn.active {
            background-color: #f8bbd0;
            color: #c2185b;
        }
        
        .highlight-btn:hover {
            background-color: #fce4ec;
        }
        
        /* äº¤è´§çŠ¶æ€æ ·å¼ */
        .due-soon {
            background-color: #fff3cd;
            color: #856404;
        }
        
        /* é€šçŸ¥æ ·å¼ */
        #notification {
            min-width: 250px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* è¡¨å•é”™è¯¯æ ·å¼ */
        .error-message {
            font-size: 0.875rem;
            line-height: 1.25;
        }
        
        /* è¡¨æ ¼è¡Œè¿‡æ¸¡æ•ˆæœ */
        .record-row {
            transition: all 0.2s ease;
        }
        
        /* ä¼˜åŒ–è¾“å…¥æ¡†æ ·å¼ */
        input.form-control:focus,
        select.form-control:focus,
        textarea.form-control:focus {
            border-color: #2196F3;
            box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.25);
        }
        
        /* æŒ‰é’®ç‚¹å‡»åé¦ˆ */
        button:focus {
            outline: none;
        }
        
        /* ç»Ÿè®¡å¡ç‰‡æ‚¬åœæ•ˆæœ */
        .stats-card:hover {
            transform: translateY(-2px);
        }
        /* å¢å¼ºé€‰æ‹©å™¨ç‰¹å¼‚æ€§ï¼Œä½¿ç”¨æ›´åè°ƒçš„ç²‰è‰² */
        table.table tbody tr.record-row.manually-highlighted {
            background-color: #f8bbd0 !important; /* æ›´æŸ”å’Œçš„ç²‰è‰²èƒŒæ™¯ */
            color: #c2185b !important; /* åè°ƒçš„æ–‡å­—é¢œè‰² */
            border: 1px solid #f48fb1;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(248, 187, 208, 0.5);
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }
        
        /* è¦†ç›–è¡¨æ ¼è¡Œçš„é»˜è®¤èƒŒæ™¯è‰² */
        table.table tbody tr.record-row.manually-highlighted td {
            background-color: transparent !important;
            color: #c2185b !important;
            border-color: #f48fb1;
        }

        .manually-highlighted .editable-color:hover,
        .manually-highlighted .editable-quantity:hover,
        .manually-highlighted .editable-delivered:hover {
            background-color: rgba(227, 242, 253, 0.5);
        }
        /* ç¡®ä¿æ“ä½œæŒ‰é’®å§‹ç»ˆå¯ç‚¹å‡» */
        .action-btn {
            position: relative;
            z-index: 10; /* ç¡®ä¿æŒ‰é’®åœ¨æœ€é«˜å±‚çº§ */
            outline: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 32px;
            padding: 0 8px;
        }
        .progress-bar { width: 100px; height: 6px; background: #ddd; border-radius: 3px; overflow: hidden; margin: 0 auto; display: inline-block; vertical-align: middle; }
        .progress-fill { height: 100%; background: #28a745; transition: width 0.3s; }
        .progress-fill.warning { background: #ffc107; }
        .progress-fill.danger { background: #dc3545; }
        .stats-card { text-align: center; font-size: 1.5em; font-weight: bold; color: #007bff; transition: transform 0.2s ease; } 
        .stats-card:hover { transform: scale(1.05); } 
        .stats-card-container { transition: transform 0.3s ease, box-shadow 0.3s ease; margin-bottom: 15px; } 
        .stats-card-container:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); }
        /* ç¡®ä¿ç»Ÿè®¡å¡ç‰‡åœ¨ä¸€è¡Œæ˜¾ç¤º */
        .stats-row { display: flex; gap: 15px; }
        .stats-row > div { flex: 1; min-width: 0; }
        .delivery-status { 
            font-size: 12px; 
            font-weight: bold; 
            margin-top: 2px; 
            text-align: center; 
            text-transform: uppercase; 
            color: #555; 
            padding: 3px 8px; 
            border-radius: 4px; 
            display: inline-block; 
        }
        .delivery-status.completed { color: #28a745; }
        .delivery-status.pending { color: #ffc107; }
        .delivery-status.delayed { color: #dc3545; font-weight: bold; }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .card { margin-bottom: 15px; }
            .btn { font-size: 14px; }
            .form-control { font-size: 14px; }
            .stats-card { font-size: 1.2em; }
            .row > div { padding: 2px; }
            .form-control, .btn { font-size: 14px; padding: 6px; }
            .action-btn { padding: 2px 4px; font-size: 12px; }
            /* ä¸éšè—ä»»ä½•åˆ—ï¼Œç¡®ä¿çŠ¶æ€åˆ—å’Œå¤‡æ³¨åˆ—éƒ½èƒ½æ­£å¸¸æ˜¾ç¤º */
            .progress-bar { width: 60px; }
            .customer-cell { font-size: 14px; padding: 10px 0; }
            .stats-card { font-size: 1em; }
        }

        /* å¯¼å…¥å¯¼å‡ºæŒ‰é’®æ ·å¼ */
        .import-export-group { 
            margin: 15px 0; 
            display: flex; 
            gap: 12px; 
            flex-wrap: wrap; 
            align-items: center; 
        }
        .import-export-group button, .import-export-group input { 
            font-size: 14px; 
            padding: 8px 12px; 
            transition: all 0.2s ease; 
            border-radius: 6px; 
        }
        /* åŠ è½½æŒ‡ç¤ºå™¨æ ·å¼ */
        #loadingIndicator {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">äº¤è´§æé†’ç³»ç»Ÿ</h1>
        
        <!-- å¯¼å…¥å¯¼å‡ºåŒºåŸŸ -->
        <div class="import-export-group">
            <button id="exportCSV" class="btn btn-success btn-sm"><i class="fas fa-file-export mr-1"></i> å¯¼å‡ºCSV</button>
            <button id="exportJSON" class="btn btn-info btn-sm"><i class="fas fa-database mr-1"></i> æ•°æ®å¤‡ä»½</button>
            <label class="btn btn-secondary btn-sm">
                <i class="fas fa-file-import mr-1"></i> å¯¼å…¥JSON
                <input id="importData" type="file" accept=".json" style="display: none;" />
            </label>
            <label class="btn btn-secondary btn-sm">
                <i class="fas fa-table mr-1"></i> å¯¼å…¥CSV
                <input id="importCSV" type="file" accept=".csv" style="display: none;" />
            </label>
        </div>
        
        <!-- æ·»åŠ è¡¨å• -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4><i class="fas fa-plus-circle mr-2"></i>æ·»åŠ è®°å½•</h4>
            </div>
            <div class="card-body">
                <form id="deliveryForm" class="row d-flex items-center gap-2 mb-2">
                    <!-- æ‰€æœ‰å­—æ®µå’ŒæŒ‰é’®åœ¨åŒä¸€è¡Œ -->
                    <div class="col-auto">
                        <label class="form-label mb-1">å®¢æˆ·åç§° *</label>
                        <input type="text" id="customerName" class="form-control" placeholder="å®¢æˆ·åç§°" required style="min-width: 150px;">
                    </div>
                    <div class="col-auto">
                        <label class="form-label mb-1">äº§å“åç§° *</label>
                        <input type="text" id="productName" class="form-control" placeholder="äº§å“åç§°" required style="min-width: 150px;">
                    </div>
                    <div class="col-auto">
                        <label class="form-label mb-1">è‰²å· *</label>
                        <input type="text" id="colorCode" class="form-control" placeholder="è‰²å·" required style="min-width: 80px;">
                    </div>
                    <div class="col-auto">
                        <label class="form-label mb-1">æ•°é‡(KG) *</label>
                        <input type="number" id="quantity" class="form-control" placeholder="æ•°é‡" min="0.1" step="0.1" required style="min-width: 80px;">
                    </div>
                    <div class="col-auto">
                        <label class="form-label mb-1">äº¤è´§æ—¥æœŸ *</label>
                        <input type="date" id="deliveryDate" class="form-control" required style="min-width: 150px;">
                    </div>
                    <div class="col-auto">
                        <label class="form-label mb-1">å¤‡æ³¨</label>
                        <input type="text" id="notes" class="form-control" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆé€‰å¡«ï¼‰" style="min-width: 200px;">
                    </div>
                    <div class="col-auto align-self-end" style="margin-bottom: 0.5rem;">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save mr-1"></i> ä¿å­˜è®°å½•
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- ç­›é€‰æ¡ä»¶å¡ç‰‡ -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h4><i class="fas fa-filter mr-2"></i>ç­›é€‰æ¡ä»¶</h4>
            </div>
            <div class="card-body">
                <div class="row d-flex items-center gap-1">
                    <div class="col-auto">
                        <input type="text" id="filterCustomer" class="form-control" placeholder="ç­›é€‰å®¢æˆ·" style="min-width: 150px;">
                    </div>
                    <div class="col-auto">
                        <input type="text" id="filterProduct" class="form-control" placeholder="ç­›é€‰äº§å“" style="min-width: 150px;">
                    </div>
                    <div class="col-auto">
                        <input type="text" id="filterColor" class="form-control" placeholder="è‰²å·" style="min-width: 80px;">
                    </div>
                    <div class="col-auto">
                        <input type="text" id="filterQuantity" class="form-control" placeholder="æ•°é‡" style="min-width: 80px;">
                    </div>
                    <div class="col-auto">
                        <input type="text" id="filterDelivery" class="form-control" placeholder="äº¤è´§æ—¥æœŸ" style="min-width: 150px;">
                    </div>
                    <div class="col-auto">
                        <input type="text" id="filterRecordTime" class="form-control" placeholder="è®°å½•æ—¶é—´" style="min-width: 150px;">
                    </div>
                    <div class="col-auto">
                        <input type="text" id="filterDaysLeft" class="form-control" placeholder="å‰©ä½™å¤©æ•°" style="min-width: 80px;">
                    </div>
                    <div class="col-auto">
                        <button id="clearFilters" class="btn btn-secondary">
                            <i class="fas fa-times mr-1"></i> æ¸…é™¤
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="row stats-row mb-4">
            <div class="col stats-card-container">
                <div class="card stats-card h-100">
                    <div class="card-body">
                        <i class="fas fa-list text-primary mb-2"></i>
                        <p class="text-muted">æ€»è®°å½•æ•°</p>
                        <div class="text-2xl font-bold text-primary" id="totalRecords">0</div>
                    </div>
                </div>
            </div>
            <div class="col stats-card-container">
                <div class="card stats-card h-100">
                    <div class="card-body">
                        <i class="fas fa-exclamation-triangle text-warning mb-2"></i>
                        <p class="text-muted">å³å°†åˆ°æœŸ</p>
                        <div class="text-2xl font-bold text-warning" id="dueSoonCount">0</div>
                    </div>
                </div>
            </div>
            <div class="col stats-card-container">
                <div class="card stats-card h-100">
                    <div class="card-body">
                        <i class="fas fa-star text-danger mb-2"></i>
                        <p class="text-muted">å·²æ ‡çº¢</p>
                        <div class="text-2xl font-bold text-danger" id="highlightedCount">0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¡¨æ ¼å®¹å™¨ -->
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h4><i class="fas fa-table mr-2"></i>äº¤è´§æ•°æ®åˆ—è¡¨</h4>
            </div>
            <div class="card-body">
                <div id="loadingIndicator" style="display: none;">
                    <i class="fas fa-spinner fa-spin mr-2"></i> åŠ è½½ä¸­...
                </div>
                <table class="table table-hover table-responsive">
                    <thead class="table-dark">
                        <tr>
                            <th>å®¢æˆ·åç§°</th>
                            <th>äº§å“åç§°</th>
                            <th>è‰²å·</th>
                            <th>æ•°é‡(KG)</th>
                            <th>å·²äº¤è´§(KG)</th>
                            <th>è¿˜å·®(KG)</th>
                            <th>äº¤è´§æ—¥æœŸ</th>
                            <th>ç™»è®°æ—¥æœŸ</th>
                            <th>å‰©ä½™å¤©æ•°</th>
                            <th>çŠ¶æ€</th>
                            <th>è¿›åº¦</th>
                            <th>å¤‡æ³¨</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- è¡¨æ ¼æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('é¡µé¢DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
        
        // DOMå…ƒç´ 
        const form = document.getElementById('deliveryForm');
        const tableBody = document.getElementById('tableBody');
        const filterCustomer = document.getElementById('filterCustomer');
        const filterProduct = document.getElementById('filterProduct');
        const filterColor = document.getElementById('filterColor');
        const filterQuantity = document.getElementById('filterQuantity');
        const filterDelivery = document.getElementById('filterDelivery');
        const filterRecordTime = document.getElementById('filterRecordTime');
        const filterDaysLeft = document.getElementById('filterDaysLeft');
        const clearFilters = document.getElementById('clearFilters');
        const totalRecords = document.getElementById('totalRecords');
        const dueSoonCount = document.getElementById('dueSoonCount');
        const highlightedCount = document.getElementById('highlightedCount');
        
        // æ•°æ®å­˜å‚¨
        let deliveries = [];
        
        // é€šçŸ¥æç¤ºå‡½æ•°
        function showNotification(message, type = 'info') {
            let notification = document.getElementById('notification');
            if (notification) {
                notification.remove();
            }
            
            notification = document.createElement('div');
            notification.id = 'notification';
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full`;
            
            if (type === 'success') {
                notification.classList.add('bg-success', 'text-white');
                notification.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
            } else if (type === 'error') {
                notification.classList.add('bg-danger', 'text-white');
                notification.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${message}`;
            } else if (type === 'warning') {
                notification.classList.add('bg-warning', 'text-white');
                notification.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${message}`;
            } else {
                notification.classList.add('bg-info', 'text-white');
                notification.innerHTML = `<i class="fas fa-info-circle mr-2"></i>${message}`;
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 10);
            
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // ç”Ÿæˆå”¯ä¸€ ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        // æ ¹æ® ID è·å–ç´¢å¼• - ä½¿ç”¨å®½æ¾æ¯”è¾ƒä»¥å¤„ç†ç±»å‹ä¸åŒ¹é…é—®é¢˜
        function getIndexById(id) {
            // å°è¯•è½¬æ¢ä¸ºæ•°å­—ç±»å‹è¿›è¡Œæ¯”è¾ƒï¼Œè§£å†³å­—ç¬¦ä¸²å’Œæ•°å­—ä¸åŒ¹é…çš„é—®é¢˜
            const numericId = typeof id === 'string' ? parseInt(id, 10) : id;
            return deliveries.findIndex(d => d.id === numericId || d.id == id);
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats(total, dueSoon, highlighted) {
            totalRecords.textContent = total;
            dueSoonCount.textContent = dueSoon;
            highlightedCount.textContent = highlighted;
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // å“åº”å¼ä¼˜åŒ–
        function handleResize() {
            const cards = document.querySelectorAll('.stats-card-container');
            if (window.innerWidth < 768) {
                cards.forEach(card => {
                    card.classList.add('mb-2');
                });
            } else {
                cards.forEach(card => {
                    card.classList.remove('mb-2');
                });
            }
        }

        // åŠ è½½æ•°æ®
        function loadData() {
            console.log('å°è¯•ä»localStorageåŠ è½½æ•°æ®...');
            try {
                const savedData = localStorage.getItem('deliveries');
                if (savedData) {
                    deliveries = JSON.parse(savedData) || [];
                    console.log('æˆåŠŸè§£ææ•°æ®ï¼Œè®°å½•æ•°é‡:', deliveries.length);
                    
                    // æ•°æ®ç»“æ„ä¿®å¤
                    deliveries.forEach(item => {
                        if (!item.id) item.id = generateId();
                        if (item.highlight === undefined) item.highlight = false;
                        if (item.deliveredQuantity === undefined) item.deliveredQuantity = '0.0';
                        if (item.quantity && typeof item.quantity === 'string') {
                            item.quantity = parseFloat(item.quantity).toFixed(1);
                        }
                        // ç¡®ä¿noteså±æ€§å­˜åœ¨ä¸”ä¸æ˜¯çŠ¶æ€å€¼
                        if (item.notes === undefined) item.notes = '';
                        // é˜²æ­¢çŠ¶æ€å€¼è¢«é”™è¯¯èµ‹å€¼ç»™notes
                        const statusValues = ['completed', 'delayed', 'pending', 'å·²å®Œæˆ', 'å»¶è¯¯', 'æœªå®Œæˆ', 'å³å°†åˆ°æœŸ', 'è¿›è¡Œä¸­'];
                        if (statusValues.includes(item.notes)) {
                            item.notes = '';
                        }
                        // ç¡®ä¿notesæ˜¯å­—ç¬¦ä¸²ç±»å‹
                        item.notes = String(item.notes || '');
                    });
                    
                    // ä¿å­˜ä¿®å¤åçš„æ•°æ®
                    localStorage.setItem('deliveries', JSON.stringify(deliveries));
                }
            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
                showNotification('æ•°æ®åŠ è½½å‡ºé”™', 'error');
                
                // å°è¯•ä»å¤‡ä»½æ¢å¤
                try {
                    const backup = localStorage.getItem('deliveries_backup');
                    if (backup) {
                        deliveries = JSON.parse(backup);
                        localStorage.setItem('deliveries', JSON.stringify(deliveries));
                        showNotification('å·²ä»å¤‡ä»½æ¢å¤æ•°æ®', 'warning');
                    }
                } catch (e) {
                    console.error('å¤‡ä»½æ¢å¤å¤±è´¥:', e);
                }
            }
        }

        // ä¿å­˜æ•°æ®
        function saveData() {
            try {
                localStorage.setItem('deliveries', JSON.stringify(deliveries));
                return true;
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                showNotification('ä¿å­˜æ•°æ®å¤±è´¥', 'error');
                return false;
            }
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'block';
            
            setTimeout(() => {
                tableBody.innerHTML = '';
                const today = new Date(); today.setHours(0, 0, 0, 0);
                
                let countDueSoon = 0;
                let countHighlighted = 0;

                // ç­›é€‰é€»è¾‘
                const fc = filterCustomer.value.trim().toLowerCase();
                const fp = filterProduct.value.trim().toLowerCase();
                const fco = filterColor.value.trim().toLowerCase();
                const fq = filterQuantity.value.trim();
                const fd = filterDelivery.value.trim();
                const frt = filterRecordTime.value.trim().toLowerCase();
                const fdl = filterDaysLeft.value.trim();

                const filtered = deliveries.filter(item => {
                    // åŸºç¡€ç­›é€‰
                    const matchCustomer = !fc || item.customerName.toLowerCase().includes(fc);
                    const matchProduct = !fp || item.productName.toLowerCase().includes(fp);
                    const matchColor = !fco || item.colorCode.toLowerCase().includes(fco);
                    const matchRecordTime = !frt || item.recordTime.toLowerCase().includes(frt);

                    // æ•°é‡ç­›é€‰
                    let matchQuantity = true;
                    if (fq) {
                        const qty = parseFloat(item.quantity);
                        if (fq.startsWith('>')) {
                            const val = parseFloat(fq.slice(1));
                            matchQuantity = !isNaN(val) ? qty > val : true;
                        } else if (fq.startsWith('<')) {
                            const val = parseFloat(fq.slice(1));
                            matchQuantity = !isNaN(val) ? qty < val : true;
                        } else if (fq.includes('~')) {
                            const [min, max] = fq.split('~').map(x => parseFloat(x.trim()));
                            matchQuantity = (!isNaN(min) ? qty >= min : true) && (!isNaN(max) ? qty <= max : true);
                        } else {
                            const val = parseFloat(fq);
                            matchQuantity = !isNaN(val) ? qty === val : true;
                        }
                    }

                    // äº¤è´§æ—¥æœŸç­›é€‰
                    let matchDelivery = true;
                    if (fd) {
                        const delivery = item.deliveryDate;
                        if (fd.startsWith('<') || fd.startsWith('>')) {
                            const op = fd[0];
                            const dateStr = fd.slice(1).trim();
                            if (dateStr) {
                                const compDate = new Date(dateStr);
                                const itemDate = new Date(item.deliveryDate);
                                if (op === '>' && itemDate <= compDate) matchDelivery = false;
                                if (op === '<' && itemDate >= compDate) matchDelivery = false;
                            }
                        } else if (fd.includes('~')) {
                            const [start, end] = fd.split('~').map(d => d.trim());
                            if (start) {
                                const startDate = new Date(start);
                                const itemDate = new Date(item.deliveryDate);
                                if (itemDate < startDate) matchDelivery = false;
                            }
                            if (end && matchDelivery) {
                                const endDate = new Date(end);
                                const itemDate = new Date(item.deliveryDate);
                                if (itemDate > endDate) matchDelivery = false;
                            }
                        } else {
                            matchDelivery = delivery.includes(fd);
                        }
                    }

                    // å‰©ä½™å¤©æ•°ç­›é€‰
                    let matchDaysLeft = true;
                    if (fdl) {
                        const deliveryDate = new Date(item.deliveryDate);
                        deliveryDate.setHours(0, 0, 0, 0);
                        const timeDiff = deliveryDate - today;
                        const daysLeft = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

                        if (fdl.startsWith('>')) {
                            const val = parseInt(fdl.slice(1));
                            matchDaysLeft = !isNaN(val) ? daysLeft > val : true;
                        } else if (fdl.startsWith('<')) {
                            const val = parseInt(fdl.slice(1));
                            matchDaysLeft = !isNaN(val) ? daysLeft < val : true;
                        } else if (fdl.includes('~')) {
                            const [min, max] = fdl.split('~').map(x => parseInt(x.trim()));
                            matchDaysLeft = (!isNaN(min) ? daysLeft >= min : true) && (!isNaN(max) ? daysLeft <= max : true);
                        } else {
                            const val = parseInt(fdl);
                            matchDaysLeft = !isNaN(val) ? daysLeft === val : true;
                        }
                    }

                    return matchCustomer && matchProduct && matchColor && matchQuantity && matchDelivery && matchRecordTime && matchDaysLeft;
                });

                // æ— æ•°æ®æ—¶æ˜¾ç¤ºæç¤º
                if (filtered.length === 0) {
                    tableBody.innerHTML = `
                    <tr class="no-records">
                        <td colspan="12" class="text-center py-6">
                            <div class="p-6 bg-light rounded-lg shadow-sm">
                                <div class="text-4xl text-muted mb-3">ğŸ“</div>
                                <h4 class="text-lg font-medium mb-2">æš‚æ— æ•°æ®è®°å½•</h4>
                                <p class="text-muted mb-4">ç‚¹å‡»ä¸Šæ–¹çš„"æ·»åŠ è®°å½•"æŒ‰é’®å¼€å§‹å½•å…¥æ•°æ®</p>
                                <button id="quick-add-btn" class="btn btn-primary btn-sm">
                                    <i class="fas fa-plus mr-1"></i> å¿«é€Ÿæ·»åŠ 
                                </button>
                            </div>
                        </td>
                    </tr>`;
                    
                    document.getElementById('quick-add-btn').addEventListener('click', function() {
                        document.getElementById('customerName').focus();
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });
                    
                    updateStats(0, 0, 0);
                    loadingIndicator.style.display = 'none';
                    return;
                }

                // æŒ‰å®¢æˆ·åˆ†ç»„
                const customerGroups = new Map();
                filtered.forEach(item => {
                    if (!customerGroups.has(item.customerName)) {
                        customerGroups.set(item.customerName, []);
                    }
                    customerGroups.get(item.customerName).push(item);
                });

                // æ¸²æŸ“è¡¨æ ¼æ•°æ®
                for (const [customerName, records] of customerGroups) {
                    // å®¢æˆ·åˆ†ç»„æ ‡é¢˜
                    const headerRow = document.createElement('tr');
                    headerRow.innerHTML = `<td colspan="12" class="customer-cell"><i class="fas fa-user-tie me-2"></i> ${customerName} (å…± ${records.length} æ¡)</td>`;
                    tableBody.appendChild(headerRow);

                    // æ¸²æŸ“æ¯æ¡è®°å½•
                    records.forEach(record => {
                        const deliveryDate = new Date(record.deliveryDate);
                        deliveryDate.setHours(0, 0, 0, 0);
                        const timeDiff = deliveryDate - today;
                        const daysLeft = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

                        // è®¡ç®—äº¤è´§çŠ¶æ€
                        const delivered = parseFloat(record.deliveredQuantity);
                        const total = parseFloat(record.quantity);
                        
                        // æ£€æŸ¥æ˜¯å¦å»¶è¯¯ï¼šå‰©ä½™å¤©æ•°å°äº-2ï¼ˆå³è¶…è¿‡åŸå®šæœŸé™2å¤©ä»¥ä¸Šï¼‰
                        let status = 'pending';
                        if (delivered >= total) {
                            status = 'completed';
                        } else if (daysLeft < -2) {
                            status = 'delayed'; // å»¶è¯¯çŠ¶æ€
                        }

                        // ç»Ÿè®¡è®¡æ•°
                        if (daysLeft <= 5) countDueSoon++;
                        if (record.highlight) countHighlighted++;

                        // åˆ›å»ºè¡¨æ ¼è¡Œ
                        const row = document.createElement('tr');
                        row.classList.add('record-row');

                        // æ·»åŠ é«˜äº®æ ·å¼
                        if (record.highlight) {
                            row.classList.add('manually-highlighted');
                        } else if (daysLeft <= 5) {
                            row.classList.add('due-soon');
                        }

                        // è¿›åº¦æ¡æ ·å¼
                        let progressClass = 'progress-fill';
                        if (daysLeft <= 2) progressClass += ' danger';
                        else if (daysLeft <= 5) progressClass += ' warning';

                        // è®¡ç®—å‰©ä½™æ•°é‡
                        const remaining = Math.max(0, total - delivered).toFixed(1);

                        // æ ¼å¼åŒ–ç™»è®°æ—¥æœŸ
                        const recordDate = new Date(record.recordTime || new Date()).toLocaleDateString('zh-CN');
                        
                        // æ„å»ºè¡Œå†…å®¹
                        row.innerHTML = `
                            <td>${record.customerName}</td>
                            <td>${record.productName}</td>
                            <td class="editable-color" data-id="${record.id}" title="ç‚¹å‡»ä¿®æ”¹è‰²å·">${record.colorCode}</td>
                            <td class="editable-quantity" data-id="${record.id}" title="ç‚¹å‡»ä¿®æ”¹æ•°é‡">${record.quantity} KG</td>
                            <td class="editable-delivered" data-id="${record.id}" title="åŒå‡»ç¼–è¾‘å·²äº¤è´§æ•°é‡">${delivered.toFixed(1)} KG</td>
                            <td>${remaining} KG</td>
                            <td class="editable-date" data-id="${record.id}" title="ç‚¹å‡»ä¿®æ”¹äº¤è´§æ—¥æœŸ">${record.deliveryDate}</td>
                            <td>${recordDate}</td>
                            <td><strong>${daysLeft} å¤©</strong></td>
                            <td>
                                <div class="delivery-status ${status}">${status === 'completed' ? 'å·²å®Œæˆ' : status === 'delayed' ? 'å»¶è¯¯' : 'æœªå®Œæˆ'}</div>
                            </td>
                            <td>
                                <div class="progress-bar">
                                    <div class="${progressClass}" style="width: ${Math.max(5, 100 - daysLeft * 5)}%"></div>
                                </div>
                            </td>
                            <td>${record.notes || ''}</td>
                            <td>
                                <div class="d-flex gap-1">
                                        <button class="action-btn edit-btn" data-id="${record.id}"><i class="fas fa-edit"></i></button>
                                        <button class="action-btn delete-btn" data-id="${record.id}"><i class="fas fa-trash"></i></button>
                                        <button class="action-btn highlight-btn ${record.highlight ? 'active' : ''}" data-id="${record.id}"><i class="fas fa-star"></i></button>
                                    </div>
                            </td>
                        `;

                        tableBody.appendChild(row);
                    });
                }

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                updateStats(filtered.length, countDueSoon, countHighlighted);
                loadingIndicator.style.display = 'none';
            }, 0);
        }

        // è¡¨æ ¼è¡Œç‚¹å‡»äº‹ä»¶å¤„ç† - ä½¿ç”¨ç®€åŒ–ç‰ˆæœ¬ç¡®ä¿åœ¨Electronç¯å¢ƒä¸­æ­£å¸¸å·¥ä½œ
        tableBody.addEventListener('click', function(e) {
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†ç¼–è¾‘æŒ‰é’®
            let target = e.target;
            // å¤„ç†ç‚¹å‡»å›¾æ ‡æˆ–æŒ‰é’®çš„æƒ…å†µ
            if (target.tagName === 'I' && target.parentElement.classList.contains('edit-btn')) {
                target = target.parentElement;
            }
            
            if (target.classList.contains('edit-btn')) {
                try {
                    // è·å–IDå¹¶ç›´æ¥æŸ¥æ‰¾è®°å½•
                    const id = target.getAttribute('data-id');
                    if (!id) {
                        console.warn('ç¼–è¾‘æŒ‰é’®ç¼ºå°‘IDå±æ€§');
                        return;
                    }
                    
                    // ç¡®ä¿deliveriesæ•°ç»„å­˜åœ¨
                    if (!Array.isArray(deliveries)) {
                        console.error('deliveriesä¸æ˜¯æœ‰æ•ˆçš„æ•°ç»„');
                        return;
                    }
                    
                    // ç›´æ¥éå†æ•°ç»„æŸ¥æ‰¾è®°å½•
                    const recordIndex = deliveries.findIndex(d => d && d.id == id); // æ·»åŠ é¢å¤–çš„ç©ºå€¼æ£€æŸ¥
                    
                    if (recordIndex !== -1 && deliveries[recordIndex]) {
                        const currentNotes = deliveries[recordIndex].notes || '';
                        
                        // åˆ›å»ºè‡ªå®šä¹‰æ¨¡æ€å¯¹è¯æ¡†
                        const modal = document.createElement('div');
                        modal.className = 'notes-modal';
                        modal.innerHTML = `
                            <div class="notes-modal-content">
                                <div class="notes-modal-header">
                                    <h3>ç¼–è¾‘å¤‡æ³¨</h3>
                                    <button class="notes-modal-close">&times;</button>
                                </div>
                                <div class="notes-modal-body">
                                    <textarea id="notes-input" rows="5" style="width: 100%; resize: vertical;">${currentNotes}</textarea>
                                </div>
                                <div class="notes-modal-footer">
                                    <button class="notes-modal-cancel">å–æ¶ˆ</button>
                                    <button class="notes-modal-save">ä¿å­˜</button>
                                </div>
                            </div>
                        `;
                        
                        // æ·»åŠ æ¨¡æ€æ¡†æ ·å¼
                        const style = document.createElement('style');
                        style.textContent = `
                            .notes-modal {
                                position: fixed;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background-color: rgba(0, 0, 0, 0.5);
                                display: flex;
                                justify-content: center;
                                align-items: center;
                                z-index: 10000;
                            }
                            .notes-modal-content {
                                background-color: white;
                                padding: 20px;
                                border-radius: 5px;
                                width: 90%;
                                max-width: 500px;
                                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                            }
                            .notes-modal-header {
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 15px;
                            }
                            .notes-modal-header h3 {
                                margin: 0;
                            }
                            .notes-modal-close {
                                background: none;
                                border: none;
                                font-size: 24px;
                                cursor: pointer;
                            }
                            .notes-modal-body {
                                margin-bottom: 15px;
                            }
                            .notes-modal-footer {
                                display: flex;
                                justify-content: flex-end;
                                gap: 10px;
                            }
                            .notes-modal button {
                                padding: 8px 16px;
                                border: none;
                                border-radius: 3px;
                                cursor: pointer;
                            }
                            .notes-modal-save {
                                background-color: #4CAF50;
                                color: white;
                            }
                            .notes-modal-cancel {
                                background-color: #f1f1f1;
                            }
                            #notes-input {
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 3px;
                                font-family: inherit;
                                font-size: 14px;
                            }
                        `;
                        document.head.appendChild(style);
                        document.body.appendChild(modal);
                        
                        // è®¾ç½®æ–‡æœ¬æ¡†ç„¦ç‚¹
                        const textarea = modal.querySelector('#notes-input');
                        textarea.focus();
                        
                        // å…³é—­æ¨¡æ€æ¡†å‡½æ•°
                        function closeModal() {
                            document.body.removeChild(modal);
                            document.head.removeChild(style);
                        }
                        
                        // ä¿å­˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                        modal.querySelector('.notes-modal-save').addEventListener('click', function() {
                            const newNotes = textarea.value.trim();
                            deliveries[recordIndex].notes = newNotes;
                            
                            // ä¿å­˜æ•°æ®å¹¶æ›´æ–°ç•Œé¢
                            try {
                                if (typeof saveData === 'function' && saveData()) {
                                    if (typeof showNotification === 'function') {
                                        showNotification('å¤‡æ³¨å·²æ›´æ–°', 'success');
                                    }
                                    if (typeof renderTable === 'function') {
                                        renderTable();
                                    }
                                }
                            } catch (saveErr) {
                                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', saveErr);
                            }
                            
                            closeModal();
                        });
                        
                        // å–æ¶ˆæŒ‰é’®å’Œå…³é—­æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                        modal.querySelector('.notes-modal-cancel').addEventListener('click', closeModal);
                        modal.querySelector('.notes-modal-close').addEventListener('click', closeModal);
                        
                        // æŒ‰ESCé”®å…³é—­æ¨¡æ€æ¡†
                        modal.addEventListener('keydown', function(e) {
                            if (e.key === 'Escape') {
                                closeModal();
                            }
                        });
                    }
                } catch (err) {
                    console.error('ç¼–è¾‘å¤‡æ³¨è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', err);
                    // ç›´æ¥å°è¯•ä½¿ç”¨alertä½œä¸ºæœ€åçš„å¤‡é€‰æ–¹æ¡ˆ
                    try {
                        alert('ç¼–è¾‘å¤‡æ³¨æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•');
                    } catch (alertErr) {
                        console.error('æ— æ³•æ˜¾ç¤ºé”™è¯¯æç¤º:', alertErr);
                    }
                }
            }

            // åˆ é™¤è®°å½•
            else if (e.target.closest('.delete-btn')) {
                const btn = e.target.closest('.delete-btn');
                const id = btn.getAttribute('data-id');
                
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                    const index = getIndexById(id);
                    if (index !== -1) {
                        deliveries.splice(index, 1);
                        if (saveData()) {
                            showNotification('è®°å½•å·²åˆ é™¤', 'success');
                            renderTable();
                        }
                    }
                }
            }

            // æ ‡çº¢/å–æ¶ˆæ ‡çº¢
            else if (e.target.closest('.highlight-btn')) {
                const btn = e.target.closest('.highlight-btn');
                const id = btn.getAttribute('data-id');
                const index = getIndexById(id);
                
                if (index !== -1) {
                    deliveries[index].highlight = !deliveries[index].highlight;
                    if (saveData()) {
                        showNotification(deliveries[index].highlight ? 'å·²æ ‡çº¢' : 'å·²å–æ¶ˆæ ‡çº¢', 'success');
                        renderTable();
                    }
                }
            }

                // ç‚¹å‡»ä¿®æ”¹è‰²å· - å†…è”ç¼–è¾‘
            else if (e.target.classList.contains('editable-color')) {
                const cell = e.target;
                const id = cell.getAttribute('data-id');
                const index = getIndexById(id);
                
                if (index !== -1) {
                    const currentValue = deliveries[index].colorCode;
                    startInlineEdit(cell, currentValue, function(newValue) {
                        if (newValue !== null && newValue.trim()) {
                            deliveries[index].colorCode = newValue.trim();
                            if (saveData()) {
                                showNotification('è‰²å·å·²æ›´æ–°', 'success');
                                renderTable();
                                return true;
                            }
                        }
                        return false;
                    });
                }
            }

            // ç‚¹å‡»ä¿®æ”¹æ•°é‡ - å†…è”ç¼–è¾‘
            else if (e.target.classList.contains('editable-quantity')) {
                const cell = e.target;
                const id = cell.getAttribute('data-id');
                const index = getIndexById(id);
                
                if (index !== -1) {
                    const currentValue = deliveries[index].quantity;
                    startInlineEdit(cell, currentValue, function(newValue) {
                        if (newValue !== null) {
                            const numValue = parseFloat(newValue);
                            if (!isNaN(numValue) && numValue > 0) {
                                deliveries[index].quantity = numValue.toFixed(1);
                                if (saveData()) {
                                    showNotification('æ•°é‡å·²æ›´æ–°', 'success');
                                    renderTable();
                                    return true;
                                }
                            } else {
                                showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡', 'error');
                            }
                        }
                        return false;
                    }, 'number');
                }
            }
            
            // ç‚¹å‡»ä¿®æ”¹äº¤è´§æ—¥æœŸ - å†…è”ç¼–è¾‘
            else if (e.target.classList.contains('editable-date')) {
                const cell = e.target;
                const id = cell.getAttribute('data-id');
                const index = getIndexById(id);
                
                if (index !== -1) {
                    const currentValue = deliveries[index].deliveryDate;
                    startInlineEdit(cell, currentValue, function(newValue) {
                        if (newValue !== null && newValue) {
                            // éªŒè¯æ—¥æœŸæ ¼å¼
                            const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
                            if (dateRegex.test(newValue)) {
                                deliveries[index].deliveryDate = newValue;
                                if (saveData()) {
                                    showNotification('äº¤è´§æ—¥æœŸå·²æ›´æ–°', 'success');
                                    renderTable(); // é‡æ–°æ¸²æŸ“è¡¨æ ¼ä¼šè‡ªåŠ¨æ›´æ–°å‰©ä½™å¤©æ•°
                                    return true;
                                }
                            } else {
                                showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸæ ¼å¼', 'error');
                            }
                        } else {
                            showNotification('äº¤è´§æ—¥æœŸä¸èƒ½ä¸ºç©º', 'error');
                        }
                        return false;
                    }, 'date');
                }
            }
        });

        // åŒå‡»ç¼–è¾‘å·²äº¤è´§æ•°é‡ - å†…è”ç¼–è¾‘
        tableBody.addEventListener('dblclick', function(e) {
            if (e.target.classList.contains('editable-delivered')) {
                const cell = e.target;
                const id = cell.getAttribute('data-id');
                const index = getIndexById(id);
                
                if (index !== -1) {
                    // è·å–æ˜¾ç¤ºå€¼ï¼ˆå»æ‰KGåç¼€ï¼‰
                    const displayValue = cell.textContent.trim().replace(' KG', '');
                    startInlineEdit(cell, displayValue, function(newValue) {
                        if (newValue !== null) {
                            const numValue = parseFloat(newValue);
                            if (!isNaN(numValue) && numValue >= 0) {
                                deliveries[index].deliveredQuantity = numValue.toFixed(1);
                                if (saveData()) {
                                    showNotification('å·²æ›´æ–°äº¤è´§æ•°é‡', 'success');
                                    renderTable();
                                    return true;
                                }
                            } else {
                                showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡', 'error');
                            }
                        }
                        return false;
                    }, 'number');
                }
            }
        });
        
        // é€šç”¨å†…è”ç¼–è¾‘å‡½æ•°
        function startInlineEdit(cell, currentValue, saveCallback, type = 'text') {
            // ä¿å­˜åŸå§‹å†…å®¹ï¼Œç”¨äºå–æ¶ˆç¼–è¾‘æ—¶æ¢å¤
            const originalContent = cell.innerHTML;
            
            // åˆ›å»ºè¾“å…¥æ¡†
            const input = document.createElement('input');
            input.type = type;
            input.value = currentValue;
            input.className = 'inline-edit-input form-control';
            input.style.width = '100%';
            input.style.height = '100%';
            input.style.boxSizing = 'border-box';
            
            // å¯¹äºæ—¥æœŸç±»å‹ï¼Œè®¾ç½®æœ€å°æ—¥æœŸä¸ºä»Šå¤©
            if (type === 'date') {
                input.min = new Date().toISOString().split('T')[0];
            }
            
            // æ¸…ç©ºå•å…ƒæ ¼å¹¶æ·»åŠ è¾“å…¥æ¡†
            cell.innerHTML = '';
            cell.appendChild(input);
            
            // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
            input.focus();
            input.select();
            
            // å¤„ç†å¤±ç„¦äº‹ä»¶
            input.addEventListener('blur', function() {
                handleSave(input.value);
            });
            
            // å¤„ç†é”®ç›˜äº‹ä»¶
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œé˜²æ­¢è¡¨å•æäº¤
                    e.preventDefault();
                    handleSave(input.value);
                } else if (e.key === 'Escape') {
                    // æ¢å¤åŸå§‹å†…å®¹
                    cell.innerHTML = originalContent;
                }
            });
            
            // ä¿å­˜å¤„ç†å‡½æ•°
            function handleSave(value) {
                // è°ƒç”¨ä¿å­˜å›è°ƒï¼Œå¦‚æœæˆåŠŸåˆ™æ¸²æŸ“è¡¨æ ¼ï¼Œå¤±è´¥åˆ™æ¢å¤åŸå§‹å†…å®¹
                const saved = saveCallback(value);
                if (!saved) {
                    // å¦‚æœä¿å­˜å¤±è´¥ï¼Œæ¢å¤åŸå§‹å†…å®¹
                    cell.innerHTML = originalContent;
                }
            }
        }

        // è¡¨å•æäº¤äº‹ä»¶
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const customerName = document.getElementById('customerName').value.trim();
            const productName = document.getElementById('productName').value.trim();
            const colorCode = document.getElementById('colorCode').value.trim();
            const quantity = document.getElementById('quantity').value;
            const deliveryDate = document.getElementById('deliveryDate').value;
            const notes = document.getElementById('notes').value.trim();

            // éªŒè¯
            if (!customerName || !productName || !colorCode || !quantity || !deliveryDate) {
                showNotification('è¯·å¡«å†™å¿…å¡«å­—æ®µ', 'error');
                return;
            }

            // åˆ›å»ºæ–°è®°å½•
            const newItem = {
                id: generateId(),
                customerName,
                productName,
                colorCode,
                quantity: parseFloat(quantity).toFixed(1),
                deliveryDate,
                notes,
                recordTime: new Date().toISOString(), // ç™»è®°æ—¥æœŸï¼ˆISOæ ¼å¼ï¼Œæ–¹ä¾¿å¤„ç†ï¼‰
                deliveredQuantity: '0.0',
                highlight: false
            };

            deliveries.push(newItem);
            if (saveData()) {
                showNotification('æ·»åŠ æˆåŠŸ', 'success');
                form.reset();
                renderTable();
            }
        });

        // ç­›é€‰è¾“å…¥æ¡†äº‹ä»¶
        [filterCustomer, filterProduct, filterColor, filterQuantity, filterDelivery, filterRecordTime, filterDaysLeft].forEach(input => {
            input.addEventListener('input', debounce(renderTable, 300));
        });

        // æ¸…é™¤ç­›é€‰
        clearFilters.addEventListener('click', function() {
            filterCustomer.value = '';
            filterProduct.value = '';
            filterColor.value = '';
            filterQuantity.value = '';
            filterDelivery.value = '';
            filterRecordTime.value = '';
            filterDaysLeft.value = '';
            renderTable();
        });

        // å¯¼å‡ºCSV
            document.getElementById('exportCSV').addEventListener('click', function() {
                let csvContent = 'å®¢æˆ·åç§°,äº§å“åç§°,è‰²å·,æ•°é‡(KG),å·²äº¤è´§æ•°é‡(KG),è¿˜å·®æ•°é‡(KG),äº¤è´§æ—¥æœŸ,ç™»è®°æ—¥æœŸ,å‰©ä½™å¤©æ•°,çŠ¶æ€,å¤‡æ³¨\n';
            
            const today = new Date();
            deliveries.forEach(item => {
                const deliveryDate = new Date(item.deliveryDate);
                const daysLeft = Math.ceil((deliveryDate - today) / (1000 * 60 * 60 * 24));
                const delivered = parseFloat(item.deliveredQuantity);
                const total = parseFloat(item.quantity);
                const remaining = Math.max(0, total - delivered).toFixed(1);
                const status = delivered >= total ? 'å·²å®Œæˆ' : (daysLeft <= 5 ? 'å³å°†åˆ°æœŸ' : 'è¿›è¡Œä¸­');
                
                // æ ¼å¼åŒ–ç™»è®°æ—¥æœŸ
                const recordDate = new Date(item.recordTime || new Date()).toLocaleDateString('zh-CN');
                
                const row = [
                    '"' + item.customerName + '"',
                    '"' + item.productName + '"',
                    '"' + item.colorCode + '"',
                    item.quantity,
                    delivered.toFixed(1),
                    remaining,
                    item.deliveryDate,
                    recordDate,
                    daysLeft,
                    '"' + status + '"',
                    '"' + (item.notes || '') + '"'
                ];
                csvContent += row.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = 'äº¤è´§æ•°æ®_' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('CSVå¯¼å‡ºæˆåŠŸ', 'success');
        });

        // å¯¼å‡ºJSONï¼ˆå¤‡ä»½ï¼‰
        document.getElementById('exportJSON').addEventListener('click', function() {
            const dataStr = JSON.stringify(deliveries, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = 'äº¤è´§æ•°æ®å¤‡ä»½_' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('æ•°æ®å¤‡ä»½æˆåŠŸ', 'success');
        });

        // å¯¼å…¥JSON
        document.getElementById('importData').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (Array.isArray(importedData)) {
                        importedData.forEach(item => {
                            if (!item.id) item.id = generateId();
                            if (item.highlight === undefined) item.highlight = false;
                            if (item.deliveredQuantity === undefined) item.deliveredQuantity = '0.0';
                            if (!item.recordTime) item.recordTime = new Date().toISOString();
                        });
                        
                        deliveries = [...deliveries, ...importedData];
                        if (saveData()) {
                            showNotification('æ•°æ®å¯¼å…¥æˆåŠŸ', 'success');
                            renderTable();
                        }
                    } else {
                        showNotification('å¯¼å…¥çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®', 'error');
                    }
                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥:', error);
                    showNotification('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
                }
            };
            reader.readAsText(file);
            this.value = '';
        });
        
        // å¯¼å…¥CSV
        document.getElementById('importCSV').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const csvContent = event.target.result;
                    const lines = csvContent.split('\n');
                    const headers = lines[0].split(',').map(header => header.replace(/"/g, '').trim());
                    
                    const importedData = [];
                    
                    // è§£æCSVè¡Œï¼ˆè€ƒè™‘å¸¦å¼•å·çš„å†…å®¹ï¼‰
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        // å¤„ç†CSVä¸­çš„å¼•å·å’Œé€—å·
                        const values = [];
                        let currentValue = '';
                        let inQuotes = false;
                        
                        for (let j = 0; j < line.length; j++) {
                            const char = line[j];
                            if (char === '"') {
                                if (line[j+1] === '"') {
                                    // å¤„ç†åŒå¼•å·
                                    currentValue += '"';
                                    j++;
                                } else {
                                    inQuotes = !inQuotes;
                                }
                            } else if (char === ',' && !inQuotes) {
                                values.push(currentValue.trim());
                                currentValue = '';
                            } else {
                                currentValue += char;
                            }
                        }
                        values.push(currentValue.trim());
                        
                        // æŸ¥æ‰¾ç™»è®°æ—¥æœŸåˆ—çš„ç´¢å¼•
                        const recordDateIndex = headers.indexOf('ç™»è®°æ—¥æœŸ');
                        
                        // åˆ›å»ºæ•°æ®å¯¹è±¡
                        const item = {
                            id: generateId(),
                            customerName: values[0] || '',
                            productName: values[1] || '',
                            colorCode: values[2] || '',
                            quantity: values[3] || '0.0',
                            deliveredQuantity: values[4] || '0.0',
                            deliveryDate: values[6] || new Date().toISOString().split('T')[0],
                            notes: values[9] || '',
                            highlight: false,
                            // å¦‚æœCSVä¸­åŒ…å«ç™»è®°æ—¥æœŸï¼Œåˆ™ä½¿ç”¨å®ƒï¼Œå¦åˆ™ä½¿ç”¨å½“å‰æ—¥æœŸ
                            recordTime: (recordDateIndex !== -1 && values[recordDateIndex]) 
                                ? new Date(values[recordDateIndex]).toISOString() 
                                : new Date().toISOString()
                        };
                        
                        importedData.push(item);
                    }
                    
                    if (importedData.length > 0) {
                        deliveries = [...deliveries, ...importedData];
                        if (saveData()) {
                            showNotification(`æˆåŠŸå¯¼å…¥ ${importedData.length} æ¡è®°å½•`, 'success');
                            renderTable();
                        }
                    } else {
                        showNotification('æœªæ‰¾åˆ°æœ‰æ•ˆæ•°æ®', 'warning');
                    }
                } catch (error) {
                    console.error('CSVå¯¼å…¥å¤±è´¥:', error);
                    showNotification('CSVå¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
                }
            };
            reader.readAsText(file, 'UTF-8');
            this.value = '';
        });

        // å¢å¼ºçš„è‡ªåŠ¨å¤‡ä»½åŠŸèƒ½
        function performBackup(showNotificationFlag = false) {
            try {
                // å¤‡ä»½åˆ°localStorage
                localStorage.setItem('deliveries_backup', JSON.stringify(deliveries));
                console.log('æ•°æ®å·²è‡ªåŠ¨å¤‡ä»½åˆ°localStorage');
                
                // æ¯å¤©è‡ªåŠ¨å¯¼å‡ºä¸€æ¬¡å¤‡ä»½æ–‡ä»¶ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                const lastBackupDate = localStorage.getItem('lastAutoExportDate');
                const today = new Date().toDateString();
                const autoExportEnabled = localStorage.getItem('autoExportEnabled') !== 'false'; // é»˜è®¤å¯ç”¨
                
                if (autoExportEnabled && (!lastBackupDate || lastBackupDate !== today)) {
                    // è‡ªåŠ¨å¯¼å‡ºå¤‡ä»½æ–‡ä»¶
                    const dataStr = JSON.stringify(deliveries, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.href = url;
                    link.download = 'äº¤è´§æ•°æ®è‡ªåŠ¨å¤‡ä»½_' + new Date().toISOString().split('T')[0] + '.json';
                    document.body.appendChild(link);
                    // å¯¹äºè‡ªåŠ¨å¤‡ä»½ï¼Œä¸å®é™…ç‚¹å‡»ä¸‹è½½ï¼Œåªè®¾ç½®æ ‡å¿—
                    localStorage.setItem('lastAutoExportDate', today);
                    document.body.removeChild(link);
                    console.log('è‡ªåŠ¨å¯¼å‡ºå¤‡ä»½æ–‡ä»¶æ ‡è®°å·²è®¾ç½®');
                }
                
                if (showNotificationFlag) {
                    showNotification('æ•°æ®å¤‡ä»½æˆåŠŸ', 'success');
                }
                return true;
            } catch (error) {
                console.error('å¤‡ä»½å¤±è´¥:', error);
                if (showNotificationFlag) {
                    showNotification('å¤‡ä»½å¤±è´¥', 'error');
                }
                return false;
            }
        }
        
        // æ¯30åˆ†é’Ÿè‡ªåŠ¨å¤‡ä»½
        setInterval(() => {
            performBackup();
        }, 30 * 60 * 1000);

        // æ³¨æ„ï¼šå·²ç§»é™¤beforeunloadäº‹ä»¶ç›‘å¬å™¨ä»¥ç¡®ä¿Electronåº”ç”¨èƒ½å¤Ÿæ­£å¸¸é€€å‡º
        // è‡ªåŠ¨å¤‡ä»½åŠŸèƒ½å·²é€šè¿‡å®šæœŸå¤‡ä»½å®ç°ï¼Œæ— éœ€åœ¨å…³é—­æ—¶æ‰§è¡Œç‰¹æ®Šæ“ä½œ
        
        // åˆå§‹åŒ–
        handleResize();
        window.addEventListener('resize', debounce(handleResize, 200));
        loadData();
        renderTable();
        console.log('åˆå§‹åŒ–å®Œæˆ');
        
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡å¤‡ä»½
        performBackup();
    });
    </script>
</body>
</html>